<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MangaVerse – Player</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <style>
    :root {
      --vh: 1vh;
      --bg: #fff;
      --fg: #4169E1;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #111827;
        --fg: #90cdf4;
      }
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--fg);
    }
    #root {
      width: 100%;
      height: calc(var(--vh, 1vh) * 100);
      overflow: hidden;
    }
    .btn {
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      border: none;
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      font-size: 0.875rem;
      cursor: pointer;
    }
    .btn:hover {
      background: rgba(0, 0, 0, 0.7);
    }
    .top-bar, .bottom-bar {
      position: absolute;
      left: 0;
      right: 0;
      z-index: 20;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: #fff;
    }
    .top-bar {
      top: 0;
    }
    .bottom-bar {
      bottom: 0;
    }
    .arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: 10;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .arrow.left {
      left: 0;
    }
    .arrow.right {
      right: 0;
    }
    .root:hover .arrow {
      opacity: 1;
    }
    .debug {
      position: fixed;
      bottom: 0.5rem;
      right: 0.5rem;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      font-size: 0.65rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      z-index: 999;
    }
  </style>
  <!-- React + ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel for in-browser JSX (tiny penalty, acceptable for a single page) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <!-- Framer-motion -->
  <script src="https://unpkg.com/framer-motion@10/dist/framer-motion.js"></script>
  <!-- React-pageflip -->
  <script src="https://unpkg.com/react-pageflip@2.0.3/dist/index.umd.js"></script>
  <!-- Lucide icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
  <div id="root"></div>
  <!-- =========  ONE-PAGE REACT APP  ========= -->
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback, useMemo } = React;
    const { motion, AnimatePresence } = window.Motion;
    const { HTMLFlipBook, Page: FlipPage } = window.ReactPageFlip;
    const { createClient } = supabase;
    const {
      ArrowLeft, ArrowRight, X, Maximize, Wrench, Sun, Moon
    } = lucide;

    /* -------------------------------------------------- */
    /* 1.  CONFIG – point to your Supabase project        */
    /* -------------------------------------------------- */
    const supabase = createClient(
      'https://your-project.supabase.co',   // <— replace
      'your-anon-key'                       // <— replace
    );

    /* -------------------------------------------------- */
    /* 2.  tiny helpers                                   */
    /* -------------------------------------------------- */
    const toast = (msg) => {
      const t = document.createElement('div');
      t.className = 'fixed bottom-20 left-1/2 -translate-x-1/2 bg-black/70 text-white text-sm px-3 py-1 rounded';
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 2000);
    };

    /* -------------------------------------------------- */
    /* 3.  AdaptiveImage – srcSet + sizes                 */
    /* -------------------------------------------------- */
    function AdaptiveImage({ src, alt, className, sizes }) {
      if (!src) return null;
      const srcSet = [320, 640, 828, 1200, 1600]
        .map(w => `${src}?width=${w} ${w}w`)
        .join(', ');
      return (
        <img
          src={`${src}?width=640`}
          srcSet={srcSet}
          sizes={sizes || '100vw'}
          alt={alt}
          className={className}
          loading="lazy"
          decoding="async"
        />
      );
    }

    /* -------------------------------------------------- */
    /* 4.  AdOverlay (identical to original)              */
    /* -------------------------------------------------- */
    function AdOverlay({ ad, duration, onFinish }) {
      const [count, setCount] = useState(duration);
      useEffect(() => {
        const id = setInterval(() => setCount(c => (c <= 1 ? (clearInterval(id), onFinish(), 0) : c - 1)), 1000);
        return () => clearInterval(id);
      }, [duration, onFinish]);

      const clickAd = async () => {
        window.open(ad.link, '_blank');
        await supabase.rpc('increment_ad_clicks', { ad_id_param: ad.id });
      };

      return (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          className="absolute inset-0 z-50 bg-black/80 flex flex-col items-center justify-center"
        >
          <div className="relative cursor-pointer group" onClick={clickAd}>
            <AdaptiveImage src={ad.image_url} alt={ad.name} className="max-w-[90vw] max-h-[70vh] rounded" />
            <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition flex items-center justify-center">
              <span className="text-white font-bold">Visit Sponsor</span>
            </div>
          </div>
          <p className="text-white mt-3">Returning in <span className="font-bold">{count}</span>s…</p>
        </motion.div>
      );
    }

    /* -------------------------------------------------- */
    /* 5.  FlipBook (90 % of your MangaReader.jsx)        */
    /* -------------------------------------------------- */
    function FlipBook({ manga, episode, pages, onClose }) {
      const [page, setPage] = useState(0);
      const [rtl, setRtl] = useState(true);
      const [dark, setDark] = useState(false);
      const [showUI, setShowUI] = useState(true);
      const [currentAd, setCurrentAd] = useState(null);
      const [ads, setAds] = useState([]);
      const [debug, setDebug] = useState(false);
      const bookRef = useRef(null);
      const uiTimeout = useRef(null);

      const adFreq = manga.ad_frequency || 0;
      const adDur = manga.ad_duration_seconds || 10;

      /* ------- dark mode toggle ------- */
      useEffect(() => {
        document.documentElement.classList.toggle('dark', dark);
      }, [dark]);

      /* ------- load ads ------- */
      useEffect(() => {
        supabase.from('ads').select('*').then(({ data }) => setAds(data || []));
      }, []);

      /* ------- visual viewport fix ------- */
      useEffect(() => {
        const setVh = () => {
          const vh = window.visualViewport?.height || window.innerHeight;
          document.documentElement.style.setProperty('--vh', `${vh * 0.01}px`);
        };
        setVh();
        window.visualViewport?.addEventListener('resize', setVh);
        return () => window.visualViewport?.removeEventListener('resize', setVh);
      }, []);

      /* ------- keyboard nav ------- */
      useEffect(() => {
        const onKey = (e) => {
          if (currentAd) return;
          if (!bookRef.current) return;
          if (e.key === 'ArrowLeft') rtl ? bookRef.current.pageFlip().flipNext() : bookRef.current.pageFlip().flipPrev();
          if (e.key === 'ArrowRight') rtl ? bookRef.current.pageFlip().flipPrev() : bookRef.current.pageFlip().flipNext();
        };
        window.addEventListener('keydown', onKey);
        return () => window.removeEventListener('keydown', onKey);
      }, [rtl, currentAd]);

      /* ------- auto-hide UI ------- */
      const show = useCallback(() => {
        setShowUI(true);
        clearTimeout(uiTimeout.current);
        uiTimeout.current = setTimeout(() => setShowUI(false), 2500);
      }, []);
      useEffect(() => {
        show();
        const root = document.getElementById('root');
        root.addEventListener('touchstart', show);
        root.addEventListener('mousemove', show);
        return () => {
          clearTimeout(uiTimeout.current);
          root.removeEventListener('touchstart', show);
          root.removeEventListener('mousemove', show);
        };
      }, [show]);

      /* ------- ad logic ------- */
      useEffect(() => {
        if (episode.episode > 1 && adFreq > 0 && page > 0 && page % adFreq === 0) {
          const avail = ads.filter(a => a.image_url);
          if (avail.length) {
            const ad = avail[Math.floor(Math.random() * avail.length)];
            setCurrentAd(ad);
            supabase.rpc('increment_ad_views', { ad_id_param: ad.id });
          }
        }
      }, [page, adFreq, ads, episode.episode]);

      /* ------- page flip handler ------- */
      const onFlip = (e) => {
        const p = e.data;
        setPage(p);
        /* save progress */
        supabase.from('reading_progress').upsert({
          user_id: null, // anon for now
          manga_id: manga.id,
          episode_number: episode.episode,
          page_number: p,
          last_read_at: new Date().toISOString()
        });
        const total = bookRef.current.pageFlip().getPageCount();
        if (p >= total - 1) toast('Last page – next chapter soon!');
      };

      /* ------- render pages (book style – even count) ------- */
      const orderedPages = useMemo(() => {
        let arr = [...pages];
        if (arr.length % 2 !== 0) arr.push({ url: null }); // blank
        return arr.map((u, i) => ({ ...u, idx: i }));
      }, [pages]);

      return (
        <div className="relative w-full h-full overflow-hidden bg-gray-200 dark:bg-gray-900 text-[#4169E1]" dir={rtl ? 'rtl' : 'ltr'}>
          <AnimatePresence>
            {showUI && (
              <motion.header initial={{ y: -50, opacity: 0 }} animate={{ y: 0, opacity: 1 }} exit={{ y: -50, opacity: 0 }} className="top-bar">
                <div className="flex items-center gap-3">
                  <button className="btn" onClick={onClose}><X size={18} /></button>
                  <div>
                    <h1 className="font-bold text-sm">{manga.title}</h1>
                    <p className="text-xs opacity-80">Chapter {episode.episode}</p>
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  <button className="btn" onClick={() => setDark(d => !d)}>{dark ? <Sun size={16} /> : <Moon size={16} />}</button>
                  <button className="btn" onClick={() => setDebug(d => !d)}><Wrench size={16} /></button>
                </div>
              </motion.header>
            )}
          </AnimatePresence>

          <AnimatePresence>{currentAd && <AdOverlay ad={currentAd} duration={adDur} onFinish={() => setCurrentAd(null)} />}</AnimatePresence>

          <main className="w-full h-full flex items-center justify-center p-4" onClick={() => show()}>
            <HTMLFlipBook
              ref={bookRef}
              width={Math.min(window.innerWidth * 0.9, 800)}
              height={Math.min(window.innerHeight * 0.8, 1000)}
              size="stretch"
              minWidth={315}
              maxWidth={1000}
              minHeight={400}
              maxHeight={1400}
              showCover={false}
              mobileScrollSupport
              onFlip={onFlip}
              flippingTime={400}
              startPage={page}
              className="manga-book"
              drawShadow
              usePortrait
            >
              {orderedPages.map((p, i) => (
                <FlipPage key={i}>
                  <div className="w-full h-full bg-white dark:bg-gray-800 flex items-center justify-center">
                    {p.url ? (
                      <AdaptiveImage src={p.url} alt={`page ${i + 1}`} className="max-w-full max-h-full object-contain" sizes="90vw" />
                    ) : (
                      <span className="text-gray-400">Blank</span>
                    )}
                  </div>
                </FlipPage>
              ))}
            </HTMLFlipBook>
          </main>

          <AnimatePresence>
            {showUI && (
              <motion.footer initial={{ y: 50, opacity: 0 }} animate={{ y: 0, opacity: 1 }} exit={{ y: 50, opacity: 0 }} className="bottom-bar">
                <button className="btn" onClick={() => setRtl(r => !r)}>{rtl ? 'LTR' : 'RTL'}</button>
                <div className="flex-1 mx-4 text-center text-xs">
                  {page + 1} / {orderedPages.length}
                </div>
                <input
                  type="range"
                  min={0}
                  max={orderedPages.length - 1}
                  value={page}
                  onChange={e => bookRef.current.pageFlip().turnToPage(e.target.value)}
                  className="w-32"
                />
              </motion.footer>
            )}
          </AnimatePresence>

          {/* arrows */}
          <button className="arrow left btn" onClick={() => rtl ? bookRef.current.pageFlip().flipNext() : bookRef.current.pageFlip().flipPrev()}><ArrowLeft /></button>
          <button className="arrow right btn" onClick={() => rtl ? bookRef.current.pageFlip().flipPrev() : bookRef.current.pageFlip().flipNext()}><ArrowRight /></button>

          {/* debug */}
          {debug && (
            <div className="debug">
              vw:{window.innerWidth} vh:{window.innerHeight} pg:{page + 1}
            </div>
          )}
        </div>
      );
    }

    /* -------------------------------------------------- */
    /* 6.  Main component – grabs ?mangaId=123&chapter=4  */
    /* -------------------------------------------------- */
    function App() {
      const [manga, setManga] = useState(null);
      const [episode, setEpisode] = useState(null);
      const [pages, setPages] = useState([]);

      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const mid = params.get('mangaId');
        const chap = params.get('chapter') || 1;
        if (!mid) { toast('No mangaId'); return; }

        Promise.all([
          supabase.from('manga').select('*').eq('id', mid).single(),
          supabase.from('episodes').select('*').eq('manga_id', mid).eq('episode', chap).single(),
          supabase.from('pages').select('url').eq('manga_id', mid).eq('episode', chap).order('page')
        ]).then(([m, e, p]) => {
          if (m.error || e.error) { toast('Manga / chapter not found'); return; }
          setManga(m.data);
          setEpisode(e.data);
          setPages(p.data || []);
        });
      }, []);

      if (!manga) return <div className="p-4">Loading…</div>;

      return <FlipBook manga={manga} episode={episode} pages={pages} onClose={() => (window.location.href = '/')} />;
    }

    /* -------------------------------------------------- */
    /* 7.  Mount                                           */
    /* -------------------------------------------------- */
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
